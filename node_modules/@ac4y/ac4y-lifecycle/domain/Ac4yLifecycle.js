var Ac4yLifecycleAlgebra=require("../algebra/Ac4yLifecycleAlgebra.js");
var Ac4yDateTimeHandler=require("@ac4y/ac4y-utility/domain/Ac4yDateTimeHandler.js");  
var Ac4yLifecycleConstant=require("../constant/Ac4yLifecycleConstant.js");

class Ac4yLifecycle extends Ac4yLifecycleAlgebra {

    constructor(object) {

        super(object);

        if (object != undefined && object === 0) return;

        if (!this.hasLiveIndicator()) this.createLiveIndicator();
        if (!this.hasSubset()) this.createSubset();
        if (!this.hasIndicatorSet()) this.createIndicatorSet();

        if (!this.hasDimension()) {

            this.createDimension();
            this._tryFireOnCreate();
            this.born();
        }

    } // constructor

    createSelf(object){return new Ac4yLifecycle(object);}

    noLifecycleElements(object){

        object = object || this;

        delete object.liveIndicator;

        delete object.dimension;
        delete object.stage;
        delete object.step;
        delete object.station;
        delete object.state;

        delete object.startTime;
        delete object.stopTime;

        return object;

    } // noLifecycleElements

    born(){

        //console.log("Ac4yLifecycle.born");

        this.getDimension().state().becomesBorn();
        this.getDimension().stage().reachesIdle();
        this.getDimension().step().realizesBorn();

        this._tryFireOnBorn();

    }; // born

    death(){

        //console.log("Ac4yLifecycle.death");

        this.getDimension().state().becomesDeath();
        //this.getDimension().stage().reachesIdle();
        this.getDimension().step().realizesDeath();

        this._tryFireOnDeath();

    }; // death

    start(){

        //console.log("Ac4yLifecycle.start");
        
        this._setStartTimeFromSystemTime();
        
        this.getDimension().state().becomesLive();
        //this.getDimension().stage().reachesLive();
        this.getDimension().step().realizesStart();
        
        this.getLiveIndicator().switchOn();

        this._tryFireOnStart();
        
    }; // start
    
    stop(){
        
        //console.log("Ac4yLifecycle.stop");

        this._setStopTimeFromSystemTime();

        this.getDimension().state().becomesStop();
        //this.getDimension().stage().reachesIdle();
        this.getDimension().step().realizesStop();
        
        this.getLiveIndicator().switchOff();
        
        this._tryFireOnStop();
        
        this._destroy();
    
    }; // stop
    
    pause(){        
        
        //console.log("Ac4yLifecycle.pause");
        
        this.getDimension().state().becomesPause();
        //this.getDimension().stage().reachesIdle();
        this.getDimension().step().realizesPause();

        this._tryFireOnPause();
        
    }; // pause
    
    continue(){
        
        //console.log("Ac4yLifecycle.continue");
        
        this.getDimension().state().becomesLive();
        //this.getDimension().stage().reachesLive();
        this.getDimension().step().realizesContinue();

        this._tryFireOnContinue();

    }; // continue
    
    error(){
        
        //console.log("Ac4yLifecycle.error");
        
        this.getDimension().state().becomesError();
        this.getDimension().stage().reachesError();
        this.getDimension().step().realizesError();

        this._tryFireOnError();

    }; // error
    
    _destroy(){
        
        this.death();
        
        this._tryFireOnDeath();
    }
    
    _setStartTimeFromSystemTime(){this.setStartTime(new Ac4yDateTimeHandler().getSystemTime());};
    
    _setStopTimeFromSystemTime(){this.setStopTime(new Ac4yDateTimeHandler().getSystemTime());};
    
    getRunTime(){return this.getEndTime()-this.getStartTime();};
    
    isLive(){return this.getLiveIndicator().on();}
    
    getThreadId(){return this.getAc4yIdentification().getGUID();};
   
    setIndicator(key, value){return this.getIndicatorSet().put(key, value)}
    getIndicator(key){return this.getIndicatorSet().get(key)}
    
    calculateTimes(history, virtualEnd){

        if (history && history.size()>0) {

            var actual = history.getStore()[history.size()-1]
            actual.setQuit(virtualEnd);
            actual.setStay(actual.getQuit()-actual.getEntry());

            //console.log("history", history);

            for ( var index=0; index<history.size()-0; index++) {

                //console.log(history.getStore()[index]);
                var actual = history.getStore()[index];
                var next = history.getStore()[index+1];

                if (actual && next && actual.hasEntry() && next.hasEntry() ) {

                    actual.setQuit(next.getEntry());
                    actual.setStay(actual.getQuit()-actual.getEntry());

                }

            } // for

        }

    } // calculateTimes

    historySimplifying(history){

        if (history && history.size()>0) {

            for ( var index=0; index<history.size()-0; index++) {
                ///history.getStore()[index].killIdentification()
                delete history.getStore()[index].GUID
            } // for

        }

    } // historySimplifying

    calculateTimesOnHistories(){

        var virtualEnd = new Ac4yDateTimeHandler().getSystemTime()

        this.calculateTimes(this.getDimension().state().getHistory(), virtualEnd);
        this.calculateTimes(this.getDimension().stage().getHistory(), virtualEnd);
        this.calculateTimes(this.getDimension().station().getHistory(), virtualEnd);
        this.calculateTimes(this.getDimension().step().getHistory(), virtualEnd);

    } // calculateTimesOnHistories

    dimensionSimplifying(dimension){

        this.historySimplifying(dimension.getHistory());
        ///dimension.killIdentification()
        //dimension.getStock().killIdentification()
        delete dimension.GUID
        delete dimension.fact
        delete dimension.stock
        delete dimension.dimension

    } // dimensionSimplifying

    dimensionsSimplifying(){

        //this.dimensionSimplifying(this.getDimension().state());
        //this.dimensionSimplifying(this.getDimension().stage());
        //this.dimensionSimplifying(this.getDimension().station());

        ///this.getDimension().killIdentification()

        this.dimensionSimplifying(this.getDimension().step());

        this.getDimension().remove(new Ac4yLifecycleConstant().DIMENSION.stage);
        this.getDimension().remove(new Ac4yLifecycleConstant().DIMENSION.state);
        this.getDimension().remove(new Ac4yLifecycleConstant().DIMENSION.station);


    } // dimensionsSimplifying

    indicatorSetSimplifying(){

        ///this.getIndicatorSet().killIdentification()

    } // indicatorSetSimplifying

    
    getRunningTime(){
        
        return this.getDimension().step().getStock().get("death").getEntry()-this.getDimension().step().getStock().get("born").getEntry();
        
    } // getRunningTime
    
    tryGetRunningTime(){
        
        try {
            return this.getRunningTime(); 
        } catch(error){ 
            console.error(error);
            return -2;
        }
        
    } // tryGetRunningTime
    
    getInformationObject(){
        
        return {
            "nÄ‚Â©v": this.getName()
            ,"elindult": new Ac4yDateTimeHandler().getDateTimeExternalFormat(new Date(this.getStartTime()))
            ,"leÄ‚Ë‡llt": (this.hasStopTime() ? new Ac4yDateTimeHandler().getDateTimeExternalFormat(new Date(this.getStopTime())) : "mÄ‚Â©g fut")
            ,"futÄ‚Ë‡sidÄąâ€� (emp)": (this.hasStopTime() ? this.getStopTime()-this.getStartTime() : "mÄ‚Â©g fut")
            ,"dolgozik": this.isLive() 
        };
        
    } // getInformationObject
      
} // Ac4yLifecycle

module.exports=Ac4yLifecycle
