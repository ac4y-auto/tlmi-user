var Ac4yLifecycleConstant=require("../constant/Ac4yLifecycleConstant.js"); 

var Ac4yKeyValueMemory=require("@ac4y/ac4y-common/container/Ac4yKeyValueMemory.js"); 

var Ac4yLifecycleFact=require("./Ac4yLifecycleFact.js");

var Ac4yLCDStage=require("./Ac4yLCDStage.js");
var Ac4yLCDStation=require("./Ac4yLCDStation.js");
var Ac4yLCDState=require("./Ac4yLCDState.js");
var Ac4yLCDStep=require("./Ac4yLCDStep.js");

class Ac4yLCDStock extends Ac4yKeyValueMemory {
    
    constructor(object) {

        super(object);
        if (object != undefined && object === 0) return;

        this.put(new Ac4yLifecycleConstant().DIMENSION.state, new Ac4yLCDState());
        this.put(new Ac4yLifecycleConstant().DIMENSION.step, new Ac4yLCDStep());
        this.put(new Ac4yLifecycleConstant().DIMENSION.stage, new Ac4yLCDStage());
        this.put(new Ac4yLifecycleConstant().DIMENSION.station, new Ac4yLCDStation());

    } // constructor
    
    createSelf(object) {return new Ac4yLCDStock(object);}

    rebuilded(object){

        /*this.setStore(object.store);
        return this;
        */

        Object.getOwnPropertyNames(object.store).forEach( (key, index) => {

            if (this.exists(key)){

                var dimension = this.get(key);
                var sourceHistory = object.store[key].history;

                sourceHistory.store.forEach( (item, index) => {
                    delete item.ac4yIdentification;
                    dimension.getHistory().put(new Ac4yLifecycleFact(item));
                });
                
            }

        });

        return this;

    } // rebuilded
    
    state(){return this.get(new Ac4yLifecycleConstant().DIMENSION.state);}
    step(){return this.get(new Ac4yLifecycleConstant().DIMENSION.step);}
    stage(){return this.get(new Ac4yLifecycleConstant().DIMENSION.stage);}
    station(){return this.get(new Ac4yLifecycleConstant().DIMENSION.station);}

    convert2Lightweight(history){

        for ( var index=0; index<history.size()-0; index++)
            history.getStore()[index] = history.getStore()[index].lightweight();

    } // convert2Lightweight

    lightweight(){

        this.fetch( (key, dimension, index) => {

            if (dimension.getHistory().size()==0)
                this.remove(key);
                
            delete dimension.ac4yIdentification;
            delete dimension.stock;
            delete dimension.fact;
            delete dimension.GUID;
            delete dimension.createdAt;
            
            this.convert2Lightweight(dimension.getHistory());
            delete this.ac4yIdentification;
            
        });        

        return this;

    } // lightweight 
    
    add(source){

        if (source)
            source.fetch( (key, dimension, index) => {

                if (this.exists(key)) {
                    this.get(key).getHistory().add(dimension.history.store);
                }

            });

        return this;

    } // add
    
} // Ac4yLCDStock

module.exports=Ac4yLCDStock
